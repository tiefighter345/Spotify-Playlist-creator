<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Spotify Playlists</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; }
    h2 { color: #1DB954; }
    ul { list-style-type: none; padding: 0; }
    li { margin-bottom: 0.5em; }
    .login-btn { background: #1DB954; color: white; padding: 10px 20px; border: none; border-radius: 20px; cursor: pointer; }
  </style>
</head>
<body>
  <button class="login-btn" id="login-btn">Login with Spotify</button>
  <h2>Your Spotify Playlists</h2>
  <ul id="playlists"></ul>

  <script>
    const clientId = '62fe71b84f0442dbbe8f79a7c8a7150f';
    const redirectUri = 'https://tiefighter345.github.io/Spotify-Playlist-creator/index.html';
    const scopes = 'playlist-read-private playlist-modify-public playlist-modify-private';

    // PKCE helpers
    function generateCodeVerifier(length = 128) {
      const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
      let verifier = '';
      for (let i = 0; i < length; i++) {
        verifier += possible.charAt(Math.floor(Math.random() * possible.length));
      }
      return verifier;
    }

    async function generateCodeChallenge(codeVerifier) {
      const encoder = new TextEncoder();
      const data = encoder.encode(codeVerifier);
      const digest = await window.crypto.subtle.digest('SHA-256', data);
      return btoa(String.fromCharCode(...new Uint8Array(digest)))
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=+$/, '');
    }

    document.getElementById('login-btn').onclick = async function() {
      const codeVerifier = generateCodeVerifier();
      const codeChallenge = await generateCodeChallenge(codeVerifier);
      localStorage.setItem('spotify_code_verifier', codeVerifier);
      const authUrl = `https://accounts.spotify.com/authorize?client_id=${clientId}` +
        `&response_type=code&redirect_uri=${encodeURIComponent(redirectUri)}` +
        `&scope=${encodeURIComponent(scopes)}` +
        `&code_challenge_method=S256&code_challenge=${codeChallenge}`;
      window.location = authUrl;
    };

    function getQueryParams() {
      return Object.fromEntries(new URLSearchParams(window.location.search));
    }

    async function fetchSpotify(endpoint, token) {
      const res = await fetch(`https://api.spotify.com/v1/${endpoint}`, {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      return res.json();
    }

    async function exchangeToken(code) {
      const codeVerifier = localStorage.getItem('spotify_code_verifier');
      const res = await fetch('https://spotify-playlist-creator-2y33.onrender.com/exchange_token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          client_id: clientId,
          code: code,
          redirect_uri: redirectUri,
          code_verifier: codeVerifier
        })
      });
      return res.json();
    }

    window.onload = async function() {
      const params = getQueryParams();
      let accessToken = null;
      console.log('Query params:', params); // Debug
      if (params.code) {
        console.log('Found code in URL:', params.code); // Debug
        // Exchange code for access token
        const tokenData = await exchangeToken(params.code);
        console.log('Token exchange response:', tokenData); // Debug
        if (tokenData.access_token) {
          accessToken = tokenData.access_token;
          window.history.replaceState({}, document.title, redirectUri); // Clean URL
        } else {
          console.error('No access token received:', tokenData); // Debug
        }
      } else {
        console.log('No code in URL.'); // Debug
      }
      // Optionally, you can store the access token in localStorage for later use
      if (accessToken) {
        document.getElementById('login-btn').style.display = 'none';
        // Fetch user profile to get user ID
        const userProfile = await fetchSpotify('me', accessToken);
        const userId = userProfile.id;
        // Fetch playlists
        const playlistsData = await fetchSpotify('me/playlists?limit=50', accessToken);
        const playlistsList = document.getElementById('playlists');
        playlistsData.items
          .filter(playlist => playlist.owner && playlist.owner.id === userId)
          .forEach((playlist, idx) => {
            const li = document.createElement('li');
            li.innerHTML = `${idx + 1}. <a href="${playlist.external_urls.spotify}" target="_blank">${playlist.name}</a> ` +
              `<button onclick=\"navigator.clipboard.writeText('${playlist.external_urls.spotify}')\">Share</button> ` +
              `<button onclick=\"editPlaylist('${playlist.id}', '${playlist.name.replace(/'/g, "&#39;")}')\">Edit</button> ` +
              `<button onclick=\"toggleTracks('${playlist.id}', this)\">Show Tracks</button>`;
            // Add Song UI
            const addDiv = document.createElement('div');
            addDiv.id = `addsongui-${playlist.id}`;
            addDiv.innerHTML = `<input type='text' placeholder='Search for a song...' id='search-${playlist.id}' style='margin-top:5px;'> <button onclick=\"searchAndShowTracks('${playlist.id}')\">Search</button><ul id='results-${playlist.id}'></ul>`;
            li.appendChild(addDiv);
            const tracksUl = document.createElement('ul');
            tracksUl.id = `tracks-${playlist.id}`;
            tracksUl.style.display = 'none';
            li.appendChild(tracksUl);
            playlistsList.appendChild(li);
          });
        // Store access token for later use
        localStorage.setItem('spotify_access_token', accessToken);
      } else {
        console.log('No access token, showing login button.'); // Debug
      }
    };

    // Playlist editing logic
    function editPlaylist(playlistId, currentName) {
      const newName = prompt('Enter new playlist name:', currentName);
      if (newName && newName !== currentName) {
        const token = localStorage.getItem('spotify_access_token');
        fetch(`https://api.spotify.com/v1/playlists/${playlistId}`, {
          method: 'PUT',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ name: newName })
        }).then(res => {
          if (res.ok) {
            // Update the playlist name in the DOM without reloading
            const link = document.querySelector(`a[href*='/playlist/${playlistId}']`);
            if (link) link.textContent = newName;
            alert('Playlist renamed!');
          } else {
            alert('Failed to rename playlist.');
          }
        });
      }
    }
    // Show/hide tracks for a playlist
    async function toggleTracks(playlistId, btn) {
      const ul = document.getElementById(`tracks-${playlistId}`);
      if (ul.style.display === 'none') {
        btn.textContent = 'Hide Tracks';
        ul.innerHTML = '<li>Loading...</li>';
        const token = localStorage.getItem('spotify_access_token');
        let allTracks = [];
        let nextUrl = `https://api.spotify.com/v1/playlists/${playlistId}/tracks?limit=100`;
        while (nextUrl) {
          const res = await fetch(nextUrl, { headers: { 'Authorization': 'Bearer ' + token } });
          const data = await res.json();
          allTracks = allTracks.concat(data.items);
          nextUrl = data.next;
        }
        ul.innerHTML = '';
        allTracks.forEach(item => {
          const track = item.track;
          if (!track) return;
          const trackLi = document.createElement('li');
          trackLi.innerHTML = `${track.name} by ${track.artists.map(a => a.name).join(', ')} ` +
            `<button onclick=\"removeTrack('${playlistId}', '${track.uri}')\">Remove</button>`;
          ul.appendChild(trackLi);
        });
        ul.style.display = 'block';
      } else {
        btn.textContent = 'Show Tracks';
        ul.style.display = 'none';
      }
    }
    // Remove a track from a playlist
    function removeTrack(playlistId, trackUri) {
      const token = localStorage.getItem('spotify_access_token');
      fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks`, {
        method: 'DELETE',
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ tracks: [{ uri: trackUri }] })
      }).then(res => {
        if (res.ok) {
          alert('Track removed!');
          toggleTracks(playlistId, document.querySelector(`button[onclick*="toggleTracks('${playlistId}'"]`));
        } else {
          alert('Failed to remove track.');
        }
      });
    }
    // Search and show tracks for adding
    async function searchAndShowTracks(playlistId) {
      const query = document.getElementById(`search-${playlistId}`).value;
      if (!query) return;
      const token = localStorage.getItem('spotify_access_token');
      const search = await fetchSpotify(`search?q=${encodeURIComponent(query)}&type=track&limit=5`, token);
      const resultsUl = document.getElementById(`results-${playlistId}`);
      resultsUl.innerHTML = '';
      search.tracks.items.forEach(track => {
        const li = document.createElement('li');
        li.innerHTML = `${track.name} by ${track.artists.map(a => a.name).join(', ')} <button onclick=\"addTrackToPlaylist('${playlistId}', '${track.uri}')\">Add</button>`;
        resultsUl.appendChild(li);
      });
    }
    // Add a track to a playlist (from search results)
    async function addTrackToPlaylist(playlistId, trackUri) {
      const token = localStorage.getItem('spotify_access_token');
      const res = await fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks`, {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ uris: [trackUri] })
      });
      if (res.ok) {
        alert('Track added!');
        // Just clear the search box and results, but keep them visible
        document.getElementById(`search-${playlistId}`).value = '';
        document.getElementById(`results-${playlistId}`).innerHTML = '';
        // Optionally refresh tracks if visible
        const btn = document.querySelector(`button[onclick*=\\"toggleTracks('${playlistId}'\\"]`);
        if (btn && btn.textContent === 'Hide Tracks') toggleTracks(playlistId, btn);
      } else {
        alert('Failed to add track.');
      }
    }
    // Show search UI again when user types
    document.addEventListener('input', function(e) {
      if (e.target && e.target.id && e.target.id.startsWith('search-')) {
        e.target.style.display = '';
        const pid = e.target.id.replace('search-', '');
        document.getElementById(`results-${pid}`).style.display = '';
      }
    });
  </script>
</body>
</html>