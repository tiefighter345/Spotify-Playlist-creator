<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Spotify Top Tracks & Artists</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; }
    h2 { color: #1DB954; }
    ul { list-style-type: none; padding: 0; }
    li { margin-bottom: 0.5em; }
    .login-btn { background: #1DB954; color: white; padding: 10px 20px; border: none; border-radius: 20px; cursor: pointer; }
  </style>
</head>
<body>
  <button class="login-btn" id="login-btn">Login with Spotify</button>
  <h2>Spotify Top Tracks</h2>
  <ul id="tracks"></ul>
  <h2>Spotify Top Artists</h2>
  <ul id="artists"></ul>

  <script>
    const clientId = '62fe71b84f0442dbbe8f79a7c8a7150f';
    const redirectUri = 'https://tiefighter345.github.io/Spotify-Playlist-creator/index.html';
    const scopes = 'user-top-read';

    // PKCE helpers
    function generateCodeVerifier(length = 128) {
      const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
      let verifier = '';
      for (let i = 0; i < length; i++) {
        verifier += possible.charAt(Math.floor(Math.random() * possible.length));
      }
      return verifier;
    }

    async function generateCodeChallenge(codeVerifier) {
      const encoder = new TextEncoder();
      const data = encoder.encode(codeVerifier);
      const digest = await window.crypto.subtle.digest('SHA-256', data);
      return btoa(String.fromCharCode(...new Uint8Array(digest)))
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=+$/, '');
    }

    document.getElementById('login-btn').onclick = async function() {
      const codeVerifier = generateCodeVerifier();
      const codeChallenge = await generateCodeChallenge(codeVerifier);
      localStorage.setItem('spotify_code_verifier', codeVerifier);
      const authUrl = `https://accounts.spotify.com/authorize?client_id=${clientId}` +
        `&response_type=code&redirect_uri=${encodeURIComponent(redirectUri)}` +
        `&scope=${encodeURIComponent(scopes)}` +
        `&code_challenge_method=S256&code_challenge=${codeChallenge}`;
      window.location = authUrl;
    };

    function getQueryParams() {
      return Object.fromEntries(new URLSearchParams(window.location.search));
    }

    async function fetchSpotify(endpoint, token) {
      const res = await fetch(`https://api.spotify.com/v1/${endpoint}`, {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      return res.json();
    }

    async function exchangeToken(code) {
      const codeVerifier = localStorage.getItem('spotify_code_verifier');
      const res = await fetch('https://spotify-playlist-creator-2y33.onrender.com/exchange_token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          client_id: clientId,
          code: code,
          redirect_uri: redirectUri,
          code_verifier: codeVerifier
        })
      });
      return res.json();
    }

    window.onload = async function() {
      const params = getQueryParams();
      let accessToken = null;
      console.log('Query params:', params); // Debug
      if (params.code) {
        console.log('Found code in URL:', params.code); // Debug
        // Exchange code for access token
        const tokenData = await exchangeToken(params.code);
        console.log('Token exchange response:', tokenData); // Debug
        if (tokenData.access_token) {
          accessToken = tokenData.access_token;
          window.history.replaceState({}, document.title, redirectUri); // Clean URL
        } else {
          console.error('No access token received:', tokenData); // Debug
        }
      } else {
        console.log('No code in URL.'); // Debug
      }
      // Optionally, you can store the access token in localStorage for later use
      if (accessToken) {
        console.log('Access token set, hiding login button and fetching data.'); // Debug
        document.getElementById('login-btn').style.display = 'none';
        // Fetch top tracks
        const tracksData = await fetchSpotify('me/top/tracks?limit=10&time_range=medium_term', accessToken);
        console.log('Tracks data:', tracksData); // Debug
        const tracksList = document.getElementById('tracks');
        tracksData.items.forEach((track, idx) => {
          const artists = track.artists.map(a => a.name).join(', ');
          const li = document.createElement('li');
          li.textContent = `${idx + 1}. ${track.name} by ${artists}`;
          tracksList.appendChild(li);
        });
        // Fetch top artists
        const artistsData = await fetchSpotify('me/top/artists?limit=5&time_range=medium_term', accessToken);
        console.log('Artists data:', artistsData); // Debug
        const artistsList = document.getElementById('artists');
        artistsData.items.forEach((artist, idx) => {
          const genres = artist.genres.length ? artist.genres.join(', ') : 'No genres available';
          const li = document.createElement('li');
          li.textContent = `${idx + 1}. ${artist.name}: ${genres}`;
          artistsList.appendChild(li);
        });
      } else {
        console.log('No access token, showing login button.'); // Debug
      }
    };
  </script>
</body>
</html>